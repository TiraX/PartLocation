# 实施计划

本计划按照**数据准备优先**的策略组织，先完成数据合成与验证流程，确保训练数据质量后再进行模型架构实现。

---

## 阶段一：数据准备与合成（优先）

- [ ] 1. 创建项目基础结构和配置系统
   - 创建项目目录结构（configs/、data/、models/、scripts/、utils/）
   - 实现YAML配置加载模块，支持数据生成和训练配置
   - 创建requirements.txt，包含Blender Python API、PyTorch、numpy等依赖
   - _需求：7.1、7.2、7.3_

- [ ] 2. 实现FBX模型解析模块
   - 使用Blender Python API编写FBX导入和解析脚本
   - 实现自动识别并提取模型内部sections（部件）的功能
   - 支持遍历所有section并输出部件列表和层级关系
   - 处理FBX格式兼容性问题（不同DCC软件导出差异）
   - _需求：4.1.1、4.1.2、4.1.3_

- [ ] 3. 实现3D模型归一化模块
   - 实现整体模型归一化：计算边界框、一致性缩放到[-0.5, 0.5]（含padding）
   - 实现部件独立归一化：每个section单独归一化到[-0.5, 0.5]
   - 记录并输出归一化参数（原始中心点、缩放因子）
   - _需求：4.2.1~4.2.5、4.3.1、4.3.2_

- [ ] 4. 实现变换参数计算模块
   - 计算归一化部件相对于归一化整体的平移参数（部件中心在整体坐标系中的位置）
   - 计算相对旋转参数（四元数表示）
   - 计算相对缩放参数（部件相对整体的大小比例）
   - 验证参数范围合理性（平移在[-1,1]，缩放为正值）
   - _需求：4.3.3、4.3.4_

- [ ] 5. 实现Blender多视图渲染模块
   - 设置标准相机位置（前、后、左、右四个视角）
   - 实现整体模型4视图渲染并拼接为单张图像
   - 实现部件模型4视图渲染（各部件独立归一化后渲染）
   - 支持1/3/4视图拼接格式输出
   - 实现光照、背景等渲染参数配置
   - _需求：4.5.1~4.5.3_

- [ ] 6. 实现数据验证模块
   - 加载各归一化部件，应用计算的transform参数进行变换
   - 将变换后的部件拼合成完整模型
   - 渲染拼合模型图像与整体模型图像进行对比
   - 实现SSIM/MSE/IoU差异度量计算
   - 差异过大时标记为错误样本并输出日志
   - _需求：4.4.1~4.4.5_

- [ ] 7. 实现数据集生成主脚本
   - 整合FBX解析、归一化、变换计算、渲染、验证全流程
   - 实现批量处理多个FBX模型文件
   - 按规范生成数据集目录结构（train/val/test）
   - 生成labels.json标注文件（包含变换参数和归一化参数）
   - 支持数据增强选项（视角扰动、光照变化、背景随机化）
   - 输出数据集统计报告（样本数、验证通过率等）
   - _需求：4.6.1~4.6.3、4.5.4_

---

## 阶段二：数据加载与处理模块

- [ ] 8. 实现PyTorch数据集类
   - 实现PartLocationDataset类，加载整体图像和部件图像
   - 支持单视图/3视图/4视图的自动识别和分割
   - 实现多视图图像的解析和预处理（水平排列/网格排列检测）
   - 处理整体与部件视图数量不一致的混合配置
   - 实现数据增强transforms（颜色抖动、归一化等）
   - _需求：1.1~1.6_

---

## 阶段三：模型架构实现

- [ ] 9. 实现DINOv2特征提取骨干网络
   - 封装DINOv2预训练模型（支持ViT-S/14、ViT-B/14、ViT-L/14）
   - 实现特征提取接口，输出patch级别特征和CLS token
   - 支持冻结骨干网络和端到端微调两种模式
   - _需求：2.1、2.4、2.6_

- [ ] 10. 实现多视图特征聚合模块
   - 实现视图位置编码/视图类型编码
   - 实现多视图特征聚合层（View Aggregation）
   - 将多个视角特征融合为统一的整体/部件表示
   - _需求：2.2、3.2、3.6_

- [ ] 11. 实现交叉注意力特征融合模块
   - 实现Cross-Attention模块（部件为Query，整体为Key/Value）
   - 捕捉部件与整体之间的语义对应关系
   - 输出融合后的关系特征
   - _需求：2.3、2.5、3.3_

- [ ] 12. 实现变换参数预测头和完整模型
   - 实现MLP预测头，输出10个参数（平移3+旋转4+缩放3）
   - 实现四元数归一化处理
   - 整合双流编码器、视图聚合、交叉注意力、预测头为完整模型
   - _需求：3.1、3.4、3.5_

---

## 阶段四：训练与推理

- [ ] 13. 实现损失函数模块
   - 实现位置损失（L1/L2）
   - 实现旋转损失（四元数geodesic距离/角度误差）
   - 实现缩放损失（L1/对数空间L1）
   - 实现组合损失，支持可配置权重
   - _需求：5.1~5.4_

- [ ] 14. 实现训练器和训练脚本
   - 实现Trainer类，支持AdamW优化器、余弦退火学习率调度
   - 支持分层学习率（骨干网络使用较小学习率）
   - 实现混合精度训练和梯度裁剪
   - 集成TensorBoard日志记录
   - 支持检查点保存和恢复训练
   - _需求：5.5~5.8_

- [ ] 15. 实现推理接口和评估模块
   - 实现简洁的Python推理API（model.predict）
   - 自动适配不同视图配置输入
   - 实现评估指标计算（位置MAE、旋转角度误差、缩放百分比误差）
   - 实现ONNX格式导出
   - 编写推理性能benchmark脚本
   - _需求：6.1~6.5_

---

## 任务依赖关系

```
任务1 ─→ 任务2 ─→ 任务3 ─→ 任务4 ─→ 任务5 ─→ 任务6 (数据准备阶段)
                              ↓
任务7 (数据加载模块)
                              ↓
任务8 ─→ 任务9 ─→ 任务10 ─→ 任务11 (模型架构)
                              ↓
任务12 ─→ 任务13 ─→ 任务14 ─→ 任务15 (训练推理)
```

## 预估工作量

| 阶段 | 任务 | 预估时间 |
|------|------|----------|
| 数据准备 | 任务1-7 | 5-7天 |
| 数据加载 | 任务8 | 1-2天 |
| 模型架构 | 任务9-11 | 2-3天 |
| 训练推理 | 任务12-15 | 2-3天 |
| **总计** | | **10-15天** |
